name: Flyway Migrations

on:
  push:
    branches:
      - main
    paths:
      - 'src/FlywayMigrations/**' # Trigger only on changes to migration scripts
      - '.github/workflows/flyway-migration.yml' # Trigger on workflow changes
  pull_request:
    branches:
      - main
    paths:
      - 'src/FlywayMigrations/**'
      - '.github/workflows/flyway-migration.yml'

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Install Flyway CLI 11.8.2 with retry and error handling
      - name: Install Flyway
        run: |
          mkdir -p flyway
          for i in {1..3}; do
            echo "Attempt $i to download Flyway CLI 11.8.2"
            if wget -qO flyway.tar.gz https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/11.8.2/flyway-commandline-11.8.2-linux-x64.tar.gz; then
              tar -xzf flyway.tar.gz -C flyway --strip-components=1
              break
            else
              echo "Download failed, retrying in 5 seconds..."
              sleep 5
            fi
          done
          if [ ! -f flyway/flyway ]; then
            echo "Failed to download or extract Flyway CLI after 3 attempts"
            exit 1
          fi
          sudo mv flyway /usr/local/flyway
          sudo chmod +x /usr/local/flyway/flyway
        shell: bash

      # Verify AZURE_CLIENT_ID is set
      - name: Verify Managed Identity Configuration
        run: |
          if [ -z "$AZURE_CLIENT_ID" ]; then
            echo "ERROR: AZURE_CLIENT_ID is not set"
            exit 1
          else
            echo "AZURE_CLIENT_ID is set: $AZURE_CLIENT_ID"
          fi
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}

      # Run Flyway migrations
      - name: Run Flyway Migrations
        run: |
          /usr/local/flyway/flyway \
            -url="jdbc:sqlserver://healthcare-sql.database.windows.net:1433;database=HealthcareDB;encrypt=true;trustServerCertificate=false;hostNameInCertificate=*.database.windows.net;loginTimeout=30;authentication=ActiveDirectoryManagedIdentity" \
            -locations="filesystem:src/FlywayMigrations" \
            -schemas="healthcare" \
            -connectRetries=5 \
            -connectRetriesInterval=10 \
            -X \
            migrate
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}