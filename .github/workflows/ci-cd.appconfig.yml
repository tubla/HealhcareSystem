name: Sync App Configuration

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/AppointmentService/dev.appconfig.yml'
      - 'src/AuthenticationService/dev.appconfig.yml'
      - '.github/workflows/ci-cd.appconfig.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/AppointmentService/dev.appconfig.yml'
      - 'src/AuthenticationService/dev.appconfig.yml'
      - '.github/workflows/ci-cd.appconfig.yml'

jobs:
  sync-app-config:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Install yq
      run: |
        sudo snap install yq

    - name: Sync AppointmentService App Configuration
      run: |
        if [ -f src/AppointmentService/dev.appconfig.yml ]; then
          echo "Processing AppointmentService dev.appconfig.yml"
          yq e -o=json src/AppointmentService/dev.appconfig.yml | jq -r 'paths(scalars) as $p | {key: ($p | join(":")), value: getpath($p)} | select(.value != null) | if .value.type == "keyvault" then [.key, .value.vaultUri, .value.secretName] else [.key, .value] end' | while IFS=$'\t' read -r key value vaultUri secretName; do
            if [ -n "$vaultUri" ] && [ -n "$secretName" ]; then
              # Check for existing KeyVault reference
              existing=$(az appconfig kv show --name healthcare-appconfig --resource-group healthcare-rg --key "$key" --query "{contentType: contentType, vaultId: value}" -o json 2>/dev/null || echo "{}")
              existing_content_type=$(echo "$existing" | jq -r .contentType)
              existing_vault_id=$(echo "$existing" | jq -r .vaultId)
              expected_vault_id="${vaultUri}secrets/${secretName}"
              if [ "$existing_content_type" = "application/vnd.microsoft.appconfig.keyvaultref+json;charset=utf-8" ] && [ "$existing_vault_id" = "$expected_vault_id" ]; then
                echo "Skipping duplicate KeyVault reference: $key"
              else
                echo "Setting KeyVault reference: $key"
                az appconfig kv set-keyvault --name healthcare-appconfig --resource-group healthcare-rg --key "$key" --vault-url "$vaultUri" --secret-name "$secretName" --yes
              fi
            else
              # Check for existing regular key
              existing_value=$(az appconfig kv show --name healthcare-appconfig --resource-group healthcare-rg --key "$key" --query value -o tsv 2>/dev/null || echo "")
              if [ "$existing_value" = "$value" ]; then
                echo "Skipping duplicate key: $key"
              else
                echo "Setting key: $key"
                az appconfig kv set --name healthcare-appconfig --resource-group healthcare-rg --key "$key" --value "$value" --yes
              fi
            fi
          done
        fi

    - name: Sync AuthenticationService App Configuration
      run: |
        if [ -f src/AuthenticationService/dev.appconfig.yml ]; then
          echo "Processing AuthenticationService dev.appconfig.yml"
          yq e -o=json src/AuthenticationService/dev.appconfig.yml | jq -r 'paths(scalars) as $p | {key: ($p | join(":")), value: getpath($p)} | select(.value != null) | if .value.type == "keyvault" then [.key, .value.vaultUri, .value.secretName] else [.key, .value] end' | while IFS=$'\t' read -r key value vaultUri secretName; do
            if [ -n "$vaultUri" ] && [ -n "$secretName" ]; then
              # Check for existing KeyVault reference
              existing=$(az appconfig kv show --name healthcare-appconfig --resource-group healthcare-rg --key "$key" --query "{contentType: contentType, vaultId: value}" -o json 2>/dev/null || echo "{}")
              existing_content_type=$(echo "$existing" | jq -r .contentType)
              existing_vault_id=$(echo "$existing" | jq -r .vaultId)
              expected_vault_id="${vaultUri}secrets/${secretName}"
              if [ "$existing_content_type" = "application/vnd.microsoft.appconfig.keyvaultref+json;charset=utf-8" ] && [ "$existing_vault_id" = "$expected_vault_id" ]; then
                echo "Skipping duplicate KeyVault reference: $key"
              else
                echo "Setting KeyVault reference: $key"
                az appconfig kv set-keyvault --name healthcare-appconfig --resource-group healthcare-rg --key "$key" --vault-url "$vaultUri" --secret-name "$secretName" --yes
              fi
            else
              # Check for existing regular key
              existing_value=$(az appconfig kv show --name healthcare-appconfig --resource-group healthcare-rg --key "$key" --query value -o tsv 2>/dev/null || echo "")
              if [ "$existing_value" = "$value" ]; then
                echo "Skipping duplicate key: $key"
              else
                echo "Setting key: $key"
                az appconfig kv set --name healthcare-appconfig --resource-group healthcare-rg --key "$key" --value "$value" --yes
              fi
            fi
          done
        fi